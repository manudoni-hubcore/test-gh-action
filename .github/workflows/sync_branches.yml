# This workflow automatically synchronizes the production branch (main) with
# the pre-production branch (preprod) when a PR is merged to main.
#
# Workflow behavior:
# 1. When a PR is merged to main, attempt automatic merge to preprod
# 2. If successful: Push directly with commit message "chore: merge main into preprod after release"
# 3. If conflicts occur:
#    - Create a fallback branch named release-sync-YYYYMMDD-HHMMSS
#    - Merge main into the fallback branch with commit "chore: fallback merge main into <branch>"
#    - Create a PR from the fallback branch to preprod for manual resolution

name: Sync main to preprod

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  sync-branches:
    # Only run if the PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch branches
        run: |
          git fetch origin main:main
          git fetch origin preprod:preprod

      - name: Attempt automatic merge
        id: auto-merge
        run: |
          # Checkout the target branch
          git checkout preprod

          # Attempt to merge main into preprod
          if git merge main --no-edit -m "chore: merge main into preprod after release"; then
            echo "merge_status=success" >> $GITHUB_OUTPUT
            echo "Merge successful"
          else
            echo "merge_status=failed" >> $GITHUB_OUTPUT
            echo "Merge failed - conflicts detected"
            # Abort the failed merge
            git merge --abort
          fi

      - name: Push successful merge
        if: steps.auto-merge.outputs.merge_status == 'success'
        run: |
          git push origin preprod
          echo "Successfully pushed merge to preprod"

      - name: Create fallback branch on conflict
        if: steps.auto-merge.outputs.merge_status == 'failed'
        id: fallback
        run: |
          # Generate timestamp for branch name
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          FALLBACK_BRANCH="release-sync-${TIMESTAMP}"
          echo "fallback_branch=${FALLBACK_BRANCH}" >> $GITHUB_OUTPUT

          # Create and checkout the fallback branch from preprod
          git checkout -b ${FALLBACK_BRANCH} preprod

          # Attempt merge with fallback message
          git merge main --no-edit -m "chore: fallback merge main into ${FALLBACK_BRANCH}" || true

          # Push the fallback branch
          git push origin ${FALLBACK_BRANCH}
          echo "Created fallback branch: ${FALLBACK_BRANCH}"

      - name: Create Pull Request for conflicts
        if: steps.auto-merge.outputs.merge_status == 'failed'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FALLBACK_BRANCH="${{ steps.fallback.outputs.fallback_branch }}"

          # Create PR using GitHub CLI
          gh pr create \
            --base preprod \
            --head ${FALLBACK_BRANCH} \
            --title "chore: resolve merge conflicts from main to preprod" \
            --body "## Automatic Merge Conflict Resolution Required

          This PR was automatically created because the automatic merge from \`main\` to \`preprod\` failed due to conflicts.

          **Source Branch:** \`main\`
          **Target Branch:** \`preprod\`
          **Fallback Branch:** \`${FALLBACK_BRANCH}\`

          ### Action Required
          Please review and resolve the merge conflicts manually, then merge this PR to complete the synchronization.

          ### Original Trigger
          - PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}
          - Merged by: @${{ github.event.pull_request.merged_by.login }}

          ---
          *This PR was automatically generated by the sync-branches workflow.*" \
            --label "automated,merge-conflict" || echo "PR creation failed or PR already exists"

      - name: Comment on original PR (success)
        if: steps.auto-merge.outputs.merge_status == 'success'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ✅ **Branch Sync Successful**

            The branch `main` has been automatically merged into `preprod` without conflicts.

      - name: Comment on original PR (conflict)
        if: steps.auto-merge.outputs.merge_status == 'failed'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ⚠️ **Branch Sync Requires Manual Intervention**

            The automatic merge from `main` to `preprod` failed due to conflicts.

            A fallback branch `${{ steps.fallback.outputs.fallback_branch }}` has been created.
            Please check the new PR for resolving these conflicts.