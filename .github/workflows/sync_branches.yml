# This workflow automatically synchronizes the production branch (ditahc8) with
# the pre-production branch (ditahc8-ppr) when a PR is merged to ditahc8.
#
# Workflow behavior:
# 1. When a PR is merged to ditahc8, attempt automatic merge to ditahc8-ppr
# 2. If successful: Push directly with commit message "chore: merge ditahc8 into ditahc8-ppr after release"
# 3. If conflicts occur:
#    - Create a fallback branch named release-sync-YYYYMMDD-HHMMSS
#    - Merge ditahc8 into the fallback branch with commit "chore: fallback merge ditahc8 into <branch>"
#    - Create a PR from the fallback branch to ditahc8-ppr for manual resolution

name: Sync ditahc8 to ditahc8-ppr

on:
  pull_request:
    types: [closed]
    branches:
      - ditahc8

jobs:
  sync-branches:
    # Only run if the PR was merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch branches
        run: |
          git fetch origin ditahc8:ditahc8
          git fetch origin ditahc8-ppr:ditahc8-ppr

      - name: Attempt automatic merge
        id: auto-merge
        run: |
          # Checkout the target branch
          git checkout ditahc8-ppr

          # Attempt to merge ditahc8 into ditahc8-ppr
          if git merge ditahc8 --no-edit -m "chore: merge ditahc8 into ditahc8-ppr after release"; then
            echo "merge_status=success" >> $GITHUB_OUTPUT
            echo "Merge successful"
          else
            echo "merge_status=failed" >> $GITHUB_OUTPUT
            echo "Merge failed - conflicts detected"
            # Abort the failed merge
            git merge --abort
          fi

      - name: Push successful merge
        if: steps.auto-merge.outputs.merge_status == 'success'
        run: |
          git push origin ditahc8-ppr
          echo "Successfully pushed merge to ditahc8-ppr"

      - name: Create fallback branch on conflict
        if: steps.auto-merge.outputs.merge_status == 'failed'
        id: fallback
        run: |
          # Generate timestamp for branch name
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          FALLBACK_BRANCH="release-sync-${TIMESTAMP}"
          echo "fallback_branch=${FALLBACK_BRANCH}" >> $GITHUB_OUTPUT

          # Create and checkout the fallback branch from ditahc8-ppr
          git checkout -b ${FALLBACK_BRANCH} ditahc8-ppr

          # Attempt merge with fallback message
          git merge ditahc8 --no-edit -m "chore: fallback merge ditahc8 into ${FALLBACK_BRANCH}" || true

          # Push the fallback branch
          git push origin ${FALLBACK_BRANCH}
          echo "Created fallback branch: ${FALLBACK_BRANCH}"

      - name: Create Pull Request for conflicts
        if: steps.auto-merge.outputs.merge_status == 'failed'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FALLBACK_BRANCH="${{ steps.fallback.outputs.fallback_branch }}"

          # Create PR using GitHub CLI
          gh pr create \
            --base ditahc8-ppr \
            --head ${FALLBACK_BRANCH} \
            --title "chore: resolve merge conflicts from ditahc8 to ditahc8-ppr" \
            --body "## Automatic Merge Conflict Resolution Required

          This PR was automatically created because the automatic merge from \`ditahc8\` to \`ditahc8-ppr\` failed due to conflicts.

          **Source Branch:** \`ditahc8\`
          **Target Branch:** \`ditahc8-ppr\`
          **Fallback Branch:** \`${FALLBACK_BRANCH}\`

          ### Action Required
          Please review and resolve the merge conflicts manually, then merge this PR to complete the synchronization.

          ### Original Trigger
          - PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}
          - Merged by: @${{ github.event.pull_request.merged_by.login }}

          ---
          *This PR was automatically generated by the sync-branches workflow.*" \
            --label "automated,merge-conflict" || echo "PR creation failed or PR already exists"

      - name: Comment on original PR (success)
        if: steps.auto-merge.outputs.merge_status == 'success'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ✅ **Branch Sync Successful**

            The branch `ditahc8` has been automatically merged into `ditahc8-ppr` without conflicts.

      - name: Comment on original PR (conflict)
        if: steps.auto-merge.outputs.merge_status == 'failed'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ⚠️ **Branch Sync Requires Manual Intervention**

            The automatic merge from `ditahc8` to `ditahc8-ppr` failed due to conflicts.

            A fallback branch `${{ steps.fallback.outputs.fallback_branch }}` has been created.
            Please check the new PR for resolving these conflicts.